<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OwlJudge - Login</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <style>
    /* Center the login section */
    main {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background-color: #f4f4f9;
    }

    /* Simplified login box styling */
    .login-section {
      max-width: 400px;
      width: 100%;
      padding: 25px;
      background-color: #ffffff;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Heading styling */
    .login-section h1 {
      font-family: 'Montserrat', sans-serif;
      font-size: 1.8em;
      margin-bottom: 20px;
      text-align: center;
      color: #333;
    }

    /* Form group styling */
    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-family: 'Roboto', sans-serif;
      font-size: 1em;
      color: #555;
    }

    /* Input field styling */
    .form-group input {
      width: 100%;
      padding: 10px;
      box-sizing: border-box;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 1em;
      font-family: 'Roboto', sans-serif;
      transition: border-color 0.3s ease;
    }

    .form-group input:focus {
      border-color: #007bff;
      outline: none;
      box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
    }

    /* Password field with toggle icon */
    .password-wrapper {
      position: relative;
    }

    .password-wrapper .toggle-password {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      color: #666;
    }

    /* Button styling */
    .btn {
      background-color: #007bff;
      color: white;
      padding: 12px;
      border: none;
      border-radius: 5px;
      width: 100%;
      cursor: pointer;
      font-size: 1.1em;
      font-family: 'Roboto', sans-serif;
      transition: background-color 0.3s ease;
    }

    .btn:hover {
      background-color: #0056b3;
    }

    .btn:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }

    /* Error message styling */
    #error-message {
      margin-top: 10px;
      text-align: center;
      font-family: 'Roboto', sans-serif;
      font-size: 0.9em;
      padding: 8px;
      border-radius: 5px;
      display: none;
    }

    #error-message.error {
      display: block;
      background-color: #f8d7da;
      color: #721c24;
    }

    #error-message.success {
      display: block;
      background-color: #d4edda;
      color: #155724;
    }

    /* Shake animation for invalid input */
    @keyframes shake {
      0% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      50% { transform: translateX(5px); }
      75% { transform: translateX(-5px); }
      100% { transform: translateX(0); }
    }

    .shake {
      animation: shake 0.5s;
    }

    /* Responsive adjustments */
    @media (max-width: 600px) {
      .login-section {
        max-width: 90%;
        padding: 20px;
      }
      .login-section h1 {
        font-size: 1.5em;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-container">
      <div class="header-left">
        <button id="menu-toggle" class="hamburger">
          <i class="fas fa-bars"></i>
        </button>
        <div class="logo">
          <a href="{{ url_for('index') }}">
            <img src="{{ url_for('static', filename='image.png') }}" alt="OwlJudge Logo" class="logo-img">
          </a>
        </div>
      </div>
      <div class="header-middle">
        <nav>
          <ul class="nav-links">
            <li><a href="{{ url_for('index') }}">Home</a></li>
            <li><a href="{{ url_for('audience') }}">Audience</a></li>
            <li><a href="{{ url_for('about') }}">About Us</a></li>
            <li><a href="{{ url_for('contact') }}">Contact Us</a></li>
          </ul>
        </nav>
      </div>
      <div class="header-right">
        {% if current_user.is_authenticated %}
          <span>Welcome, {{ current_user.username }}</span>
          <a href="{{ url_for('logout') }}" class="btn">Logout</a>
        {% else %}
          <a href="{{ url_for('login') }}" class="btn">Login</a> |
          <a href="{{ url_for('signup') }}" class="btn">Sign Up</a>
        {% endif %}
      </div>
    </div>
  </header>

  <main>
    <section class="login-section">
      <h1>Login</h1>
      <form id="loginForm" method="POST">
        <div class="form-group">
          <label for="email">Email</label>
          <input type="email" id="email" name="email" placeholder="Enter your email" required>
        </div>
        <div class="form-group">
          <label for="password">Password</label>
          <div class="password-wrapper">
            <input type="password" id="password" name="password" placeholder="Enter your password" required>
            <i class="fas fa-eye toggle-password" id="togglePassword"></i>
          </div>
        </div>
        <div id="error-message" role="alert"></div>
        <button type="submit" class="btn">Login</button>
      </form>
    </section>
  </main>
  <footer>
    <p>Â© 2025 OwlJudge. All rights reserved.</p>
  </footer>

  <script>
    // Reset form state on page load
    window.addEventListener('load', function() {
      const form = document.getElementById("loginForm");
      const errorDiv = document.getElementById("error-message");
      const submitBtn = form.querySelector('button[type="submit"]');
      form.reset();
      errorDiv.textContent = "";
      errorDiv.classList.remove('success', 'error');
      submitBtn.innerHTML = 'Login';
      submitBtn.disabled = false;

      // Check for flashed messages in sessionStorage to prevent re-display
      const hasShownMessages = sessionStorage.getItem('hasShownMessages');
      if (!hasShownMessages) {
        // Display flashed messages only once
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              showMessage('{{ message }}', '{{ category }}');
            {% endfor %}
            // Mark messages as shown
            sessionStorage.setItem('hasShownMessages', 'true');
          {% endif %}
        {% endwith %}
      }
    });

    // Function to display messages dynamically
    function showMessage(message, type) {
      const errorDiv = document.getElementById("error-message");
      errorDiv.textContent = message;
      errorDiv.classList.remove('success', 'error');
      errorDiv.classList.add(type);
      errorDiv.style.display = 'block';

      // Hide the message after 3 seconds
      setTimeout(() => {
        errorDiv.style.display = 'none';
        errorDiv.textContent = "";
        errorDiv.classList.remove('success', 'error');
      }, 3000);
    }

    // Handle form submission
    document.getElementById("loginForm").addEventListener("submit", async function(event) {
      event.preventDefault();

      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();
      const errorDiv = document.getElementById("error-message");
      const submitBtn = this.querySelector('button[type="submit"]');
      const loginSection = document.querySelector('.login-section');

      errorDiv.textContent = "";
      errorDiv.classList.remove('success', 'error');
      errorDiv.style.display = 'none';
      loginSection.classList.remove('shake');

      if (!email || !password) {
        errorDiv.textContent = 'Email and password are required.';
        errorDiv.classList.add('error');
        errorDiv.style.display = 'block';
        loginSection.classList.add('shake');
        return;
      }

      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
      submitBtn.disabled = true;

      try {
        const formData = new FormData();
        formData.append('email', email);
        formData.append('password', password);

        const response = await fetch('/login', {
          method: 'POST',
          body: formData
        });

        if (response.ok) {
          showMessage('Login successful! Redirecting...', 'success');
          sessionStorage.removeItem('hasShownMessages'); // Reset for next login
          setTimeout(() => window.location.href = "{{ url_for('index') }}", 2000);
        } else {
          const data = await response.text();
          errorDiv.textContent = data || "Invalid email or password. Please try again.";
          errorDiv.classList.add('error');
          errorDiv.style.display = 'block';
          loginSection.classList.add('shake');
          submitBtn.innerHTML = 'Login';
          submitBtn.disabled = false;
        }
      } catch (error) {
        console.error('Login error:', error);
        errorDiv.textContent = 'A network error occurred. Please try again later.';
        errorDiv.classList.add('error');
        errorDiv.style.display = 'block';
        loginSection.classList.add('shake');
        submitBtn.innerHTML = 'Login';
        submitBtn.disabled = false;
      }
    });

    // Password visibility toggle
    document.getElementById("togglePassword").addEventListener("click", function() {
      const passwordInput = document.getElementById("password");
      if (passwordInput.type === "password") {
        passwordInput.type = "text";
        this.classList.remove("fa-eye");
        this.classList.add("fa-eye-slash");
      } else {
        passwordInput.type = "password";
        this.classList.remove("fa-eye-slash");
        this.classList.add("fa-eye");
      }
    });

    // Clear sessionStorage when navigating to login page directly
    if (window.location.pathname === "{{ url_for('login') }}") {
      sessionStorage.removeItem('hasShownMessages');
    }
  </script>

  <!-- Cloudflare script retained -->
  <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'921ea995ba1059f7',t:'MTc0MjIzNzI4NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>